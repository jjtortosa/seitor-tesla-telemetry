version: '3.8'

# Tesla Fleet Telemetry Server Stack (MQTT Edition)
#
# Quick Start:
#   1. Run ./setup.sh to configure
#   2. Copy SSL certificates to certs/
#   3. docker compose up -d
#
# Environment variables can be set in .env file (see .env.example)
#
# NOTE: This simplified stack uses MQTT instead of Kafka.
# Fleet Telemetry publishes directly to your MQTT broker (e.g., Mosquitto).

services:
  # Tesla Fleet Telemetry Server
  fleet-telemetry:
    image: tesla/fleet-telemetry:latest
    container_name: fleet-telemetry
    restart: unless-stopped
    ports:
      - "443:443"   # HTTPS for Tesla vehicle connections
      - "8443:8443" # Metrics/health endpoint
    volumes:
      - ./config.json:/config.json:ro
      - ${CERTS_PATH:-./certs}:/certs:ro
      - ${KEYS_PATH:-./keys}:/keys:ro
      - ${LOGS_PATH:-./logs}:/var/log/fleet-telemetry
    environment:
      CONFIG_FILE: /config.json
      LOG_LEVEL: ${LOG_LEVEL:-info}
    networks:
      - tesla-net
    healthcheck:
      test: ["CMD", "curl", "-f", "-k", "https://localhost:443/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  tesla-net:
    driver: bridge
